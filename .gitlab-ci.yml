variables:
        CURRENT_CI_IMAGE: 1

stages:
        - ci-image
        - run-tests

run-tests:
        stage: run-tests
        image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:18.03.1
        tags: ["runner:main", "size:large"]
        script: 
                - docker build --tag 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-lambda-layer-rb:$CURRENT_CI_IMAGE  --build-arg image=ruby:2.5 -f scripts/Dockerfile_test .
                - docker run --rm -v `pwd`:/datadog-lambda-layer-ruby -w /datadog-lambda-layer-ruby datadog-lambda-layer-ruby-test:$ruby_version rake test

 

ci-image:
        stage: ci-image
        when: manual
        except: [tags, schedules]
        tags: ["runner:docker", "size:large"]
        image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:18.03.1
        script:
                - docker build --tag 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-lambda-layer-rb:$CURRENT_CI_IMAGE  --build-arg image=ruby:2.5 -f scripts/Dockerfile_test .
                - docker push 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-lambda-layer-rb:$CURRENT_CI_IMAGE

                  #run_tests:
                  #        script: scripts/run_tests.sh

