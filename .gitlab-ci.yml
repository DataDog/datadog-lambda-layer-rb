variables:
        CURRENT_CI_IMAGE: 1

stages:
        - ci-image
        - run-tests
        - build-rc

run-tests:
        stage: run-tests
        image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-lambda-layer-rb:$CURRENT_CI_IMAGE
        tags: ["runner:main", "size:large"]
        script: 
                - bundle install
                - rubocop lib/ test/ datadog-lambda.gemspec
                - rake test

ci-image:
        stage: ci-image
        when: manual
        except: [tags, schedules]
        tags: ["runner:docker", "size:large"]
        image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:18.03.1
        script:
                - docker build --tag 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-lambda-layer-rb:$CURRENT_CI_IMAGE  --build-arg image=ruby:2.5 -f scripts/Dockerfile_test .
                - docker push 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-lambda-layer-rb:$CURRENT_CI_IMAGE


build-deploy-env:
        stage: build-rc
        image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-lambda-layer-rb:$CURRENT_CI_IMAGE
        tags: ["runner:main", "size:large"]
        script:
                - apt-get install pip
                - pip install awscli
                - aws ssm get-parameter --region us-east-1 --name ci.datadog-lambda-layer-rb.rubygems-api-key --with-decryption --query "Parameter.Value" --out text > ~/.gem/credentials 
                  #- ./scripts/push_prod.sh

